# 重定位

重定位是连接符号引用和符号定义的过程。代码中我们只需要指定函数名（符号引用）即可，但是当程序实际运行的时候，相关的CALL指令必须能够正确无误地跳转到函数实际地址处（符号定义）去执行函数代码。

可是在链接阶段之前，符号的虚拟地址（亦可称运行时地址）并没有分配`(这里需要去看？？？)`，只有在链接阶段的符号解析过程中链接器才会为符号分配虚拟地址`(这里需要去看？？？)`。在符号地址确认后，链接器这才会修改机器指令（即重定位操作是在符号解析之后），可是链接器并不会聪明到可以自动找到可重定位文件中引用外部符号的地方（即需要修改的地方），所以**可重定位文件必须包含相关的信息来告诉链接器如何去修改节的内容**，只有这样，最后生成的可执行文件或者共享库才会找到正确的信息来构建最终的进程映像。可重定位项就是帮助链接器进行重定位操作的信息。

当程序中调用一个函数时，相关的 call 指令必须在执行期将控制流转到正确的目标地址。所以，so 文件中必须包含一些重定位相关的信息，linker 据此完成重定位的工作。

## 1. 链接时重定位

在 *.o 文件链接时将发生重定位。这些重定位信息保存在一系列的重定位项中（.rel.dyn等表），重定位项结构如下：

```c
typedef struct
{
    Elf32_Addr  r_offset;       /* Address */
    Elf32_Word  r_info;         /* Relocation type and symbol index */
} Elf32_Rel;

typedef struct
{
    Elf32_Addr  r_offset;       /* Address */
    Elf32_Word  r_info;         /* Relocation type and symbol index */
    Elf32_Sword r_addend;       /* Addend */
} Elf32_Rela;
```

